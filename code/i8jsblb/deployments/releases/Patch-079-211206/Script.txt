CREATE OR REPLACE FORCE VIEW BB_SETTLEMENT_ACCOUNTS_VIEW ("ACCOUNT_ID", "ACCOUNT_HOLDER_ID", "ACCOUNT_NUMBER", "BALANCE", "ACCOUNT_TITLE", "IS_ACTIVE", "STATUS_ID", "CUSTOMER_ACCOUNT_TYPE_ID", "CUSTOMER_ACCOUNT_TYPE_NAME", "PRODUCT_ID", "PRODUCT_NAME") AS 
  SELECT A.ACCOUNT_ID,
    A.ACCOUNT_HOLDER_ID,
    A.ACCOUNT_NUMBER,
    A.BALANCE,
    H.FIRST_NAME AS ACCOUNT_TITLE,
    H.IS_ACTIVE,
    A.STATUS_ID,
    A.CUSTOMER_ACCOUNT_TYPE_ID,
    T.NAME AS CUSTOMER_ACCOUNT_TYPE_NAME,
   LISTAGG(  P.PRODUCT_ID,',') WITHIN GROUP(ORDER BY A.ACCOUNT_HOLDER_ID) AS PRODUCT_ID,
  LISTAGG( P.NAME,',') WITHIN GROUP(ORDER BY A.ACCOUNT_HOLDER_ID) AS PRODUCT_NAME
  FROM ACCOUNT A,
    ACCOUNT_HOLDER H,
    OLA_CUSTOMER_ACCOUNT_TYPE T,
    PRODUCT P,
    STAKEHOLDER_BANK_INFO SBI
  WHERE 
  
  A.ACCOUNT_HOLDER_ID      =H.ACCOUNT_HOLDER_ID
AND A.CUSTOMER_ACCOUNT_TYPE_ID =T.CUSTOMER_ACCOUNT_TYPE_ID
  AND A.CUSTOMER_ACCOUNT_TYPE_ID = 3
  AND SBI.PRODUCT_ID             = P.PRODUCT_ID (+)
  AND SBI.ACCOUNT_NO  (+)       = GET_DECODED_ACCOUNT_NO(A.ACCOUNT_NUMBER)
  AND SBI.BANK_ID (+)            = 50050
  AND H.IS_ACTIVE                = 1
  AND A.STATUS_ID                = 1
  AND A.ACCOUNT_ID              <>25
GROUP BY A.ACCOUNT_ID,
    A.ACCOUNT_HOLDER_ID,
    A.ACCOUNT_NUMBER,
    A.BALANCE,
    H.FIRST_NAME,
     H.IS_ACTIVE,
    A.STATUS_ID,
    A.CUSTOMER_ACCOUNT_TYPE_ID,
    T.NAME;

