CREATE OR REPLACE FORCE VIEW BLACKLISTED_CNICS_HISTORY_VIEW ("PK", "BLACKLISTED_CNICS_ID", "APP_USER_TYPE_ID", "APP_USER_TYPE_NAME", "USER_ID", "CUSTOMER_ACCOUNT_TYPE_ID", "ACCOUNT_TYPE", "ACCOUNT_NUMBER", "FIRST_NAME", "LAST_NAME", "BUSINESS_NAME", "MOBILE_NO", "CNIC_NO", "AC_OPENING_DATE", "LAST_ACTIVITY_DATE", "REGISTRATION_STATE_ID", "REGISTRATION_STATE", "ACCOUNT_STATUS", "IS_BLACKLISTED", "ACTION", "ACTION_DATE", "ACTION_PERFORMED_BY", "COMMENTS", "TAX_REGIME_ID", "TAX_REGIME_NAME", "CARD_NO", "SEGMENT_ID", "SEGMENT_NAME") AS 
WITH MARKED_UNMARKED_DTL
           AS (SELECT BLKLST_MARK_UNMARK_HIST_ID PK,
                      CNIC_NO,
                      ACTION,
                      A.UPDATED_ON ACTION_DATE,
                      USERNAME ACTION_PERFORMED_BY,
                      COMMENTS
                 FROM BLACKLIST_MARK_UNMARK_HISTORY A, APP_USER B
                WHERE A.UPDATED_BY = B.APP_USER_ID),
        LAST_TRNX_DATE
           AS (  SELECT ACCOUNT_ID, MAX (TRANSACTION_TIME) LAST_ACTIVITY_DATE
                   FROM LEDGER A, ACCOUNT B
                  WHERE (FROM_ACCOUNT_ID = ACCOUNT_ID
                         OR TO_ACCOUNT_ID = ACCOUNT_ID)
                        AND CUSTOMER_ACCOUNT_TYPE_ID NOT IN (3, 9)
               GROUP BY ACCOUNT_ID)
   SELECT distinct PK,
          J.BLACKLISTED_CNICS_ID,
          G.APP_USER_TYPE_ID,
          G.NAME APP_USER_TYPE_NAME,
          B.USER_ID,
          F.CUSTOMER_ACCOUNT_TYPE_ID,
          F.NAME ACCOUNT_TYPE,
           TRIM
          (
             REGEXP_REPLACE
             (
                ' ' || TRIM (TRANSLATE (ACCOUNT_NUMBER, 'DEL', ' ')),
                '(.).',
                '\1'
             )
          ) ACCOUNT_NUMBER,
          A.FIRST_NAME,
          A.LAST_NAME,
          CASE
             WHEN A.APP_USER_TYPE_ID = 3
             THEN
                (SELECT BUSINESS_NAME
                   FROM RETAILER_CONTACT
                  WHERE RETAILER_CONTACT.
                         RETAILER_CONTACT_ID = A.RETAILER_CONTACT_ID)
          END
             BUSINESS_NAME,
          A.MOBILE_NO,
          A.NIC CNIC_NO,
          A.CREATED_ON AC_OPENING_DATE,
          LAST_ACTIVITY_DATE LAST_ACTIVITY_DATE,
          A.REGISTRATION_STATE_ID,
          E.NAME REGISTRATION_STATE,
          CASE
             WHEN A.IS_CLOSED_UNSETTLED = 0 AND A.IS_CLOSED_SETTLED = 0
             THEN
                'OPEN'
             WHEN A.IS_CLOSED_UNSETTLED = 1 AND A.IS_CLOSED_SETTLED = 0
             THEN
               'CLOSED UNSETTLED'
             WHEN A.IS_CLOSED_UNSETTLED = 1 AND A.IS_CLOSED_SETTLED = 1
             THEN
                'CLOSED SETTLED'
          END
             ACCOUNT_STATUS,
          J.IS_BLACKLISTED,
          H.ACTION,
          H.ACTION_DATE,
          H.ACTION_PERFORMED_BY,
          H.COMMENTS 
         ,CASE
             WHEN A.APP_USER_TYPE_ID = '3'
             THEN
                (SELECT tx.TAX_REGIME_ID
                   FROM RETAILER_CONTACT ,tax_regime TX
                  WHERE RETAILER_CONTACT.
                         RETAILER_CONTACT_ID = A.RETAILER_CONTACT_ID
                         and RETAILER_CONTACT.TAX_REGIME_ID = tx.TAX_REGIME_ID)
           WHEN A.APP_USER_TYPE_ID = 2
             THEN
                (SELECT tx.tax_regime_id
                   FROM customer c, tax_regime TX WHERE c.customer_id = a.customer_id
                   and C.TAX_REGIME_ID = tx.TAX_REGIME_ID) 
          END
             TAX_REGIME_ID
             
          ,CASE
             WHEN A.APP_USER_TYPE_ID = 3
             THEN
                (SELECT tx.name
                   FROM RETAILER_CONTACT ,tax_regime TX
                  WHERE RETAILER_CONTACT.
                         RETAILER_CONTACT_ID = A.RETAILER_CONTACT_ID
                         and RETAILER_CONTACT.TAX_REGIME_ID = tx.TAX_REGIME_ID)
                         
                         
          WHEN A.APP_USER_TYPE_ID = 2
             THEN
                (SELECT tx.name
                   FROM customer c, tax_regime TX WHERE c.customer_id = a.customer_id
                   and C.TAX_REGIME_ID = tx.TAX_REGIME_ID)                
           
          END
             TAX_REGIME_NAME,
  Case           
  WHEN A.APP_USER_TYPE_ID = 2
             THEN
                (SELECT card_no
                   FROM DEBIT_CARD dc WHERE dc.mobile_no = a.mobile_no)                
           
          END
             CARD_NO,
  Case           
  WHEN A.APP_USER_TYPE_ID = 2
             THEN
                (SELECT s.segment_id
                   FROM customer c, segment s WHERE c.customer_id = a.customer_id
                   and c.segment_id = s.segment_id)                
           
          END
             SEGMENT_ID,
Case           
  WHEN A.APP_USER_TYPE_ID = 2
             THEN
                (SELECT s.name
                   FROM customer c, segment s WHERE c.customer_id = a.customer_id
                   and c.segment_id = s.segment_id)                
           
          END
             SEGMENT_NAME             
     FROM APP_USER A,
          ACCOUNT_HOLDER C,
          ACCOUNT D,
          REGISTRATION_STATE E,
          OLA_CUSTOMER_ACCOUNT_TYPE F,
          APP_USER_TYPE G,
          USER_DEVICE_ACCOUNTS B,
          MARKED_UNMARKED_DTL H,
          LAST_TRNX_DATE I,
          BLACKLISTED_CNICS J
    WHERE     A.APP_USER_ID = B.APP_USER_ID
          AND DEVICE_TYPE_ID = 5
          AND A.MOBILE_NO = C.MOBILE_NUMBER
          AND A.NIC = C.CNIC
          AND A.NIC = H.CNIC_NO
          AND A.NIC = J.CNIC_NO
          AND D.ACCOUNT_ID = I.ACCOUNT_ID(+)
          AND C.ACCOUNT_HOLDER_ID = D.ACCOUNT_HOLDER_ID
          AND A.REGISTRATION_STATE_ID = E.REGISTRATION_STATE_ID
          AND D.CUSTOMER_ACCOUNT_TYPE_ID = F.CUSTOMER_ACCOUNT_TYPE_ID
          AND A.APP_USER_TYPE_ID = G.APP_USER_TYPE_ID
          AND D.CUSTOMER_ACCOUNT_TYPE_ID NOT IN (3, 9,4)
          AND A.APP_USER_TYPE_ID IN (2, 3)
          AND a.IS_CLOSED_SETTLED = 0
          AND a.IS_CLOSED_UNSETTLED = 0
         --AND PK IN ('16554','17051','18551')
   UNION ALL
   SELECT PK,
          J.BLACKLISTED_CNICS_ID,
          G.APP_USER_TYPE_ID,
          G.NAME APP_USER_TYPE_NAME,
          B.USER_ID,
          F.CUSTOMER_ACCOUNT_TYPE_ID,
          F.NAME ACCOUNT_TYPE,
           TRIM
          (
             REGEXP_REPLACE
             (
                ' ' || TRIM (TRANSLATE (ACCOUNT_NUMBER, 'DEL', ' ')),
                '(.).',
                '\1'
             )
          ) ACCOUNT_NUMBER,
          A.FIRST_NAME,
          A.LAST_NAME,
          CASE
             WHEN A.APP_USER_TYPE_ID = 3
             THEN
                (SELECT BUSINESS_NAME
                   FROM RETAILER_CONTACT
                  WHERE RETAILER_CONTACT.
                         RETAILER_CONTACT_ID = A1.RETAILER_CONTACT_ID)
          END
             BUSINESS_NAME,
          A.MOBILE_NO,
          A.NIC CNIC_NO,
          A.CREATED_ON AC_OPENING_DATE,
          LAST_ACTIVITY_DATE LAST_ACTIVITY_DATE,
          A.REGISTRATION_STATE_ID,
          E.NAME REGISTRATION_STATE,
          CASE
             WHEN A.IS_CLOSED_UNSETTLED = 0 AND A.IS_CLOSED_SETTLED = 0
             THEN
                'OPEN'
             WHEN A.IS_CLOSED_UNSETTLED = 1 AND A.IS_CLOSED_SETTLED = 0
             THEN
                'CLOSED UNSETTLED'
             WHEN A.IS_CLOSED_UNSETTLED = 1 AND A.IS_CLOSED_SETTLED = 1
             THEN
                'CLOSED SETTLED'
          END
             ACCOUNT_STATUS,
          J.IS_BLACKLISTED,
          H.ACTION,
          H.ACTION_DATE,
          H.ACTION_PERFORMED_BY,
          H.COMMENTS,
          NULL AS TAX_REGIME_ID,
          NULL AS TAX_REGIME_NAME,
          NULL AS CARD_NO,
          NULL AS SEGMENT_ID,
          NULL AS SEGMENT_NAME
     FROM APP_USER A,
          USER_DEVICE_ACCOUNTS B,
          HANDLER B1,
          APP_USER A1,
          ACCOUNT_HOLDER C,
          ACCOUNT D,
          REGISTRATION_STATE E,
          OLA_CUSTOMER_ACCOUNT_TYPE F,
          APP_USER_TYPE G,
          MARKED_UNMARKED_DTL H,
          LAST_TRNX_DATE I,
          BLACKLISTED_CNICS J
    WHERE     A.APP_USER_ID = B.APP_USER_ID
          AND DEVICE_TYPE_ID = 5
          AND A1.MOBILE_NO = C.MOBILE_NUMBER
          AND A1.NIC = C.CNIC
          AND A.NIC = H.CNIC_NO
          AND A.NIC = J.CNIC_NO
          AND A.HANDLER_ID = B1.HANDLER_ID
          AND B1.PRIMARY_RETAILER_CONTACT_ID = A1.RETAILER_CONTACT_ID
          AND D.ACCOUNT_ID = I.ACCOUNT_ID(+)
          AND C.ACCOUNT_HOLDER_ID = D.ACCOUNT_HOLDER_ID
          AND A1.REGISTRATION_STATE_ID = E.REGISTRATION_STATE_ID
          AND D.CUSTOMER_ACCOUNT_TYPE_ID = F.CUSTOMER_ACCOUNT_TYPE_ID
          AND A.APP_USER_TYPE_ID = G.APP_USER_TYPE_ID
          AND D.CUSTOMER_ACCOUNT_TYPE_ID NOT IN (3, 9,4)
          AND a.IS_CLOSED_SETTLED = 0
          AND a.IS_CLOSED_UNSETTLED = 0
          AND A.APP_USER_TYPE_ID = 12;
          --AND PK IN ('16554','17051','18551');