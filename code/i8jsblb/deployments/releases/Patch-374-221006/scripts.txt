
  CREATE OR REPLACE FORCE VIEW "I8_MICROBANK_JS_PROD"."DEBIT_CARD_CHARGES_REPORT_VIEW" ("PK", "NIC", "MOBILE_NO", "MB_ACCOUNT_NO", "DEBIT_CARD_NUMBER", "ACCOUNT_TYPE", "ACCOUNT_TYPE_ID", "CHARGES_TYPE", "CHARGES_STATUS", "CHARGES_AMOUNT", "FED_RATE", "NAME", "CITY", "REGIME", "REGIME_RATE", "ACCOUNT_OPENING_DATE", "LAST_ACTIVITY_DATE", "TRANSACTION_TYPE", "TRANSACTION_DATE", "SEGMENT_ID", "SEGMENT", "ACCOUNT_STATUS", "ACCOUNT_BALANCE") AS 
  SELECT 
      ROWNUM AS PK, Y.NIC, Y.MOBILE_NO,Y.MOBILE_NO AS MB_ACCOUNT_NO, I.CARD_NO AS DEBIT_CARD_NUMBER,
      C.NAME AS ACCOUNT_TYPE,C.CUSTOMER_ACCOUNT_TYPE_ID AS ACCOUNT_TYPE_ID,A.PRODUCT_NAME AS CHARGES_TYPE,'' AS CHARGES_STATUS,'' AS CHARGES_AMOUNT,
       A.FED AS FED_RATE, B.NAME, Y.CITY, H.NAME AS REGIME, H.FED AS REGIME_RATE,
      trunc(E.CREATED_ON) AS ACCOUNT_OPENING_DATE,X.LAST_ACTIVITY_DATE AS LAST_ACTIVITY_DATE,A.PRODUCT_NAME AS TRANSACTION_TYPE, A.CREATED_ON AS TRANSACTION_DATE,
      J.SEGMENT_ID, J.NAME AS SEGMENT, CASE NVL(E.STATUS_ID,0) WHEN 1 THEN 'ACTIVE' ELSE 'IN ACTIVE' END AS ACCOUNT_STATUS,
      E.BALANCE AS ACCOUNT_BALANCE
  FROM TRANSACTION_DETAIL_MASTER A 
    INNER JOIN APP_USER Y ON  A.SALE_MOBILE_NO = Y.MOBILE_NO 
    INNER JOIN CUSTOMER B ON Y.CUSTOMER_ID = B.CUSTOMER_ID
    INNER JOIN OLA_CUSTOMER_ACCOUNT_TYPE C ON C.CUSTOMER_ACCOUNT_TYPE_ID = B.CUSTOMER_ACCOUNT_TYPE_ID
    INNER JOIN ACCOUNT_HOLDER D ON D.MOBILE_NUMBER = B.MOBILE_NO
    INNER JOIN ACCOUNT E ON E.ACCOUNT_HOLDER_ID = D.ACCOUNT_HOLDER_ID
    INNER JOIN TAX_REGIME H ON H.TAX_REGIME_ID = B.TAX_REGIME_ID
    INNER JOIN DEBIT_CARD I ON I.APP_USER_ID = Y.APP_USER_ID
    INNER JOIN SEGMENT J ON J.SEGMENT_ID = B.SEGMENT_ID
    LEFT JOIN (SELECT *
                FROM (
                SELECT LAST_ACTIVITY_DATE, SALE_MOBILE_NO, PRODUCT_NAME, RANK() OVER (PARTITION BY SALE_MOBILE_NO ORDER BY LAST_ACTIVITY_DATE DESC) MY_RANK
                FROM (
                SELECT MAX(CREATED_ON) LAST_ACTIVITY_DATE, SALE_MOBILE_NO, PRODUCT_NAME
                FROM TRANSACTION_DETAIL_MASTER
                GROUP BY SALE_MOBILE_NO, PRODUCT_NAME)
                )
                WHERE MY_RANK = 1
               ) X ON X.SALE_MOBILE_NO = Y.MOBILE_NO AND X.PRODUCT_NAME = A.PRODUCT_NAME
    WHERE  A.PRODUCT_ID IN (10245137,10245113,10245136)
    AND C.IS_CUSTOMER_ACCOUNT_TYPE = 1
    AND E.CUSTOMER_ACCOUNT_TYPE_ID !=4
    AND I.CARD_STATUS_ID = 1
    AND I.CARD_STATE_ID = 3;
