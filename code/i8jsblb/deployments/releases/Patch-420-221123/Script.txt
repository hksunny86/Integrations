
  CREATE OR REPLACE FORCE VIEW "I8_MICROBANK_JS_PROD"."DIGI_DEBIT_CARD_ANNUAL" ("APP_USER_ID", "EMBOSING_NAME", "CARD_NO", "CNIC", "MOBILE_NO", "ISSUANCE_DATE", "CURRENT_DATE", "CARD_REQUEST_DATE", "DAYS", "IS_DEDUCTION_REQUIRED", "CUSTOMER_ACCOUNT_TYPE", "FROM_ACCOUNT", "FROM_ACCOUNT_NAME", "TO_ACCOUNT", "TO_ACCOUNT_NAME", "MICROBANK_SEGMENT", "DEDUCTION_AMOUNT", "DEDUCTION_DATE", "COMMENTS") AS 
  SELECT DISTINCT DC.APP_USER_ID,
  DC.EMBOSING_NAME,
DC.CARD_NO,DC.CNIC,DC.MOBILE_NO,
SUBSTR(DC.ISSUANCE_DATE,1,9)AS "ISSUANCE_DATE",
SUBSTR(SYSDATE,1,9) "CURRENT_DATE",
DC.created_on "CARD_REQUEST_DATE",
SUBSTR((SYSDATE-(CASE WHEN DC.ISSUANCE_DATE IS NULL THEN DC.CREATED_ON ELSE DC.ISSUANCE_DATE  END)),7,5) "DAYS", 
(CASE WHEN SUBSTR((SYSDATE-(CASE WHEN DC.ISSUANCE_DATE IS NULL THEN DC.CREATED_ON ELSE DC.ISSUANCE_DATE  END)),7,5)<365 
          THEN 'NO' 
WHEN SUBSTR((SYSDATE-(CASE WHEN DC.ISSUANCE_DATE IS NULL THEN DC.CREATED_ON ELSE DC.ISSUANCE_DATE  END)),7,5)>365 
         THEN 'YES' 
          ELSE 'NO' 
          END) "IS_DEDUCTION_REQUIRED" ,
          DECODE(a.customer_account_type_id,
                    2,	'Level 1',
                    4,	'HRA') as "CUSTOMER_ACCOUNT_TYPE",         
          
          --'NULL' AS "VISION CARD STATUS",
         -- bbcv.account_number as "MICROBANK ACCOUNT", 
         TRIM
          (
             REGEXP_REPLACE
             (
                ' ' || TRIM (TRANSLATE (ACCOUNT_NUMBER, 'DEL', ' ')),
                '(.).',
                '\1'
             )
          ) AS "FROM_ACCOUNT",
          C.NAME AS FROM_ACCOUNT_NAME,
          ma.to_account_no as TO_ACCOUNT,
          ma.to_account_nick as TO_ACCOUNT_NAME,
        --  C.segment_id,
          S.NAME AS MICROBANK_SEGMENT,
          MA.AMOUNT AS DEDUCTION_AMOUNT,         
          MA.CREATED_ON AS DEDUCTION_DATE,
          MA.COMMENTS AS COMMENTS
FROM DEBIT_CARD DC INNER JOIN CUSTOMER C ON DC.MOBILE_NO=C.MOBILE_NO
INNER JOIN APP_USER AU ON C.CUSTOMER_ID =AU.CUSTOMER_ID
INNER JOIN SEGMENT S ON S.SEGMENT_ID=C.SEGMENT_ID
INNER JOIN ACCOUNT_HOLDER AH ON C.MOBILE_NO=AH.MOBILE_NUMBER
INNER JOIN ACCOUNT A ON A.ACCOUNT_HOLDER_ID=AH.ACCOUNT_HOLDER_ID
LEFT OUTER JOIN MANUAL_ADJUSTMENT MA ON MA.FROM_ACCOUNT_NO=TRIM
          (
             REGEXP_REPLACE
             (
                ' ' || TRIM (TRANSLATE (A.ACCOUNT_NUMBER, 'DEL', ' ')),
                '(.).',
                '\1'
             )
          )
and  MA.to_account_no='0001830069'

WHERE AH.IS_ACTIVE NOT IN ('0')
--AND S.NAME='IGFC SOUTH PAY AND ALLOWANCES'
--and dc.mobile_no = '03327864321'
AND C.CUSTOMER_ACCOUNT_TYPE_ID NOT IN ('1')
and a.customer_account_type_id not in ('9')
AND au.is_closed_settled NOT IN  ('1')


UNION ALL
 

SELECT  DC.APP_USER_ID,DC.EMBOSING_NAME,
DC.CARD_NO,DC.CNIC,DC.MOBILE_NO,
SUBSTR(DC.ISSUANCE_DATE,1,9)AS "ISSUANCE_DATE",
SUBSTR(SYSDATE,1,9) "CURRENT_DATE", 
DC.created_on "CARD_REQUEST_DATE",
SUBSTR((SYSDATE-(CASE WHEN DC.ISSUANCE_DATE IS NULL THEN DC.CREATED_ON ELSE DC.ISSUANCE_DATE  END)),7,5) "DAYS", 
(CASE WHEN SUBSTR((SYSDATE-(CASE WHEN DC.ISSUANCE_DATE IS NULL THEN DC.CREATED_ON ELSE DC.ISSUANCE_DATE  END)),7,5)<365 
          THEN 'NO' 
WHEN SUBSTR((SYSDATE-(CASE WHEN DC.ISSUANCE_DATE IS NULL THEN DC.CREATED_ON ELSE DC.ISSUANCE_DATE  END)),7,5)>365 
         THEN 'YES' 
          ELSE 'NO' 
          END) "IS DEDUCTION REQUIRED" ,
          --'NULL' AS "VISION CARD STATUS",
         -- bbcv.account_number as "MICROBANK ACCOUNT",
         DECODE(a.customer_account_type_id,
                    2,	'Level 1',
                    4,	'HRA') as "CUSTOMER_ACCOUNT_TYPE",
         TRIM
          (
             REGEXP_REPLACE
             (
                ' ' || TRIM (TRANSLATE (ACCOUNT_NUMBER, 'DEL', ' ')),
                '(.).',
                '\1'
             )
          ) AS "FROM_ACCOUNT",
          C.NAME AS FROM_ACCOUNT_NAME,
          ma.from_account_no as TO_ACCOUNT,
          ma.FROM_account_nick as TO_ACCOUNT_NAME,
        --  C.segment_id,
          S.NAME AS MICROBANK_SEGMENT,
          (CASE
              WHEN ma.from_account_no = ('0001830069')
              THEN
                 -1 *(Abs(ma.amount))
                 ELSE 
                 0
           END) AS DEDUCTION_AMOUNT,         
          MA.CREATED_ON AS DEDUCTION_DATE,
          MA.COMMENTS AS COMMENTS
FROM DEBIT_CARD DC INNER JOIN CUSTOMER C ON DC.MOBILE_NO=C.MOBILE_NO
INNER JOIN APP_USER AU ON C.CUSTOMER_ID =AU.CUSTOMER_ID
INNER JOIN SEGMENT S ON S.SEGMENT_ID=C.SEGMENT_ID
INNER JOIN ACCOUNT_HOLDER AH ON C.MOBILE_NO=AH.MOBILE_NUMBER
INNER JOIN ACCOUNT A ON A.ACCOUNT_HOLDER_ID=AH.ACCOUNT_HOLDER_ID
LEFT OUTER JOIN MANUAL_ADJUSTMENT MA ON MA.TO_ACCOUNT_NO=
TRIM
          (
             REGEXP_REPLACE
             (
                ' ' || TRIM (TRANSLATE (A.ACCOUNT_NUMBER, 'DEL', ' ')),
                '(.).',
                '\1'
             )
          )
and  MA.from_account_no='0001830069'


WHERE AH.IS_ACTIVE NOT IN ('0')
--AND S.NAME='IGFC SOUTH PAY AND ALLOWANCES'
--and dc.mobile_no = '03327864321'
AND C.CUSTOMER_ACCOUNT_TYPE_ID NOT IN ('1')
and ma.to_account_no is not null
AND au.is_closed_settled NOT IN  ('1')
and a.customer_account_type_id not in ('9')
order by DEDUCTION_DATE desc;
