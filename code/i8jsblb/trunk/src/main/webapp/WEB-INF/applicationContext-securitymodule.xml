<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	     xmlns:tx="http://www.springframework.org/schema/tx"
	     xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd
           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd">


  <bean id="userDao" class="com.inov8.microbank.server.dao.securitymodule.hibernate.AppUserHibernateDAO">
    <property name="sessionFactory" ref="sessionFactory"/>
    <property name="bankDAO" ref="bankDAO"/>
    <property name="supplierDAO" ref="supplierDAO"/>
    <property name="operatorDAO" ref="operatorDAO"/>
    <property name="mnoDAO" ref="mnoDAO"/>
    <property name="userPermissionViewDAO" ref="userPermissionViewDAO"/>
    <property name="dataSource" ref="dataSource"/>
  </bean>
    
  <bean id="appUserMobileHistoryDAO" class="com.inov8.microbank.server.dao.appusermobilehistorymodule.hibernate.AppUserMobileHistoryHibernateDAO">
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="userPermissionViewDAO" class="com.inov8.microbank.server.dao.usergroupmodule.hibernate.UserPermissionViewHibernateDAO">
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>

  <bean id="appUserFormListViewDao" class="com.inov8.microbank.server.dao.securitymodule.hibernate.AppUserFormListViewHibernateDAO">
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>


    <bean id="ecofinSubAgentDAO" class="com.inov8.microbank.server.dao.securitymodule.hibernate.EcofinSubAgentHibernateDAO">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>



  <bean id="userManager" parent="baseTransactionProxy">
    <property name="target">
      <bean class="com.inov8.microbank.server.service.securitymodule.AppUserManagerImpl">
          <property name="mobileNetworkDAO" ref="mobileNetworkDAO" />
          <property name="debitCardModelDAO">
              <ref bean="debitCardModelDAO" />
          </property>
          <property name="mnoUserDAO">
              <ref bean="mnoUserDAO" />
          </property>
        <property name="appUserDAO">
          <ref local="userDao"/>
        </property>
        <property name="appUserFormListViewDao">
          <ref local="appUserFormListViewDao"/>
        </property>
        <property name="appUserPartnerGroupDAO" ref="appUserPartnerGroupDAO"/>
      </bean>
    </property>
    <property name="transactionAttributes">
            <props merge="true">
                <prop key="save*">PROPAGATION_REQUIRED,-UserExistsException</prop>
            </props>
    </property>
    <!-- This property is overriden in security.xml to add
             method-level role security -->
       <!--  <property name="preInterceptors">
            <list>
                <ref bean="userSecurityInterceptor"/>
            </list>
        </property> -->
      <property name="messageSource" ref="messageSource"/>
  </bean>

  <!-- This interceptor insures that that users can only update themselves, not other users -->
   <!--  <bean id="userSecurityInterceptor" class="org.springframework.aop.support.RegexpMethodPointcutAdvisor">
        <constructor-arg value=".*saveUser"/>
        <constructor-arg ref="userSecurityAdvice"/> 
    </bean>

    <bean id="userSecurityAdvice" class="com.inov8.microbank.server.service.securitymodule.UserSecurityAdvice">
       <property name="userCache" ref="userCache"/>
    </bean> -->


    <bean id="userCache" class="org.springframework.security.core.userdetails.cache.EhCacheBasedUserCache">
        <property name="cache">
            <bean class="org.springframework.cache.ehcache.EhCacheFactoryBean">
                <property name="cacheManager">
                    <bean class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean"/>
                </property>
                <property name="cacheName" value="userCache"/>
            </bean>
        </property>
    </bean>

  <!--
  <bean id="userCache" class="org.springframework.security.core.userdetails.cache.NullUserCache">
  </bean>
  -->



  <bean id="securityFacade" class="com.inov8.microbank.server.facade.SecurityFacadeImpl">
    <property name="frameworkExceptionTranslator">
      <ref bean="frameworkExceptionTranslator"/>
    </property>

    <property name="appUserManager">
      <ref local="userManager"/>
    </property>

  </bean>

    <bean id="reTagMobileCnicHistoryModelHibernateDAO" class="com.inov8.microbank.server.dao.retagmobilecnicmodule.hibernate.ReTagMobileCnicHistoryModelHibernateDAO">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

</beans>
